<!DOCTYPE html>
<html lang="ja">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1e1e1e">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="color-scheme" content="light dark">
<title>Ultimate Markdown Editor</title>

<style>
html,body{
    margin:0;
    height:100%;
    overflow:hidden;   /* â˜… è¿½åŠ  */
    font-family:monospace;
    display:flex;
    flex-direction:column;
}

/* ===== å›ºå®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ ===== */
#menu{
    position:fixed;
    top:0;
    left:0;
    width:100%;
    display:flex;
    flex-wrap:wrap;
    gap:6px;
    padding:6px;
    background:#fff;
    border-bottom:1px solid #ccc;
    z-index:1000;
}

#menu button{
    font-size:clamp(14px,2vh,20px);
    height:clamp(34px,5vh,48px);
    padding:0 12px;
    border-radius:6px;
    border:1px solid #888;
    background:#f0f0f0;
}

#menu input{
    height:clamp(30px,4vh,40px);
}
#menuToggle{
    display:none;
}

/* å¸¸ã«æŠ˜ã‚Šç•³ã¿å¯èƒ½ã«ã™ã‚‹ */

#menu{
    flex-wrap:wrap;
    overflow:hidden;
    transition:height 0.3s ease;
}

/* æŠ˜ã‚Šç•³ã¿çŠ¶æ…‹ */
body.menu-collapsed #menu{
    height:18px;
    padding:2px 4px;
}

/* æŠ˜ã‚Šç•³ã¿æ™‚ã¯ãƒˆã‚°ãƒ«ä»¥å¤–éè¡¨ç¤º */
body.menu-collapsed #menu button:not(#menuToggle),
body.menu-collapsed #menu input,
body.menu-collapsed #menu label{
    display:none !important;
}

/* ãƒˆã‚°ãƒ«ã¯å¸¸æ™‚è¡¨ç¤º */
#menuToggle{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    font-size:11px;
    height:16px;
    padding:0 4px;
    line-height:1;
}


/* ===== æ¨ªç”»é¢æ™‚ï¼šå°å‹ãƒˆã‚°ãƒ« ===== */
.landscape #menuToggle{
    display:inline-flex;
    align-items:center;
    justify-content:center;

    font-size:14px;          /* å°ã•ã‚ */
    height:16px;             /* â† ç´„1/3ã‚µã‚¤ã‚º */
    padding:0 4px;
    line-height:1;
}

/* æŠ˜ã‚ŠãŸãŸã¿æ™‚ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼é«˜ã•ã‚’å°å‹åŒ– */
.landscape.menu-collapsed #menu{
    height:18px;        /* ãƒˆã‚°ãƒ«ã«åˆã‚ã›ã‚‹ */
    padding:2px 4px;
}
/* æŠ˜ã‚ŠãŸãŸã¿æ™‚ã¯ä»–è¦ç´ å®Œå…¨éè¡¨ç¤º */
.landscape.menu-collapsed #menu button:not(#menuToggle),
.landscape.menu-collapsed #menu input,
.landscape.menu-collapsed #menu label{
    display:none !important;
}

/* ===== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ ===== */
#container{
    position:fixed;        /* â˜… è¿½åŠ  */
    top:var(--menu-height,50px);
    left:0;
    right:0;
    bottom:0;
    display:flex;
    flex-direction:column;
    overflow:hidden;
}


.landscape #container{
    flex-direction:row;
}

#outline{
    flex:1;
    overflow:auto;
    background:#cccccc;		//#f3f3f3;
    border-bottom:1px solid #ccc;
    padding:8px 8px 8px 32px;
    font-size:14px;
}

.landscape #outline{
    border-bottom:none;
    border-right:1px solid #ccc;
}

#editorArea{
    flex:4;
    display:flex;
    overflow:hidden;
}

/* è¡Œç•ªå· */
#leftPane{
    width:90px;
    min-width:90px;
    background:#0b3d2e;
    color:white;
    overflow:hidden;        /* â† auto ã‚’ hidden ã«å¤‰æ›´ */
    touch-action:none;      /* â† Androidå¯¾ç­– */
    overscroll-behavior: none;
    text-align:right;
    padding-right:8px;
    box-sizing:border-box;
}

#lineSpacer{ height:0; }
#lineNumbers{
    white-space: pre;
}

/* å³å´ */
#rightPane{
    flex:1;
    display:flex;
    flex-direction:column;
    overflow:hidden;
}

#ruler{
    background:#cccc66;	//#eee;
    border-bottom:1px solid #ccc;
    padding-left:4px;
}

#editorWrapper{
    position:relative;
    flex:1;
}

#editor{
    width:100%;
    height:100%;
    border:none;
    outline:none;
    resize:none;
    padding:4px;
    font-family:monospace;
    white-space:pre-wrap;
    word-break:break-word;
    overflow-wrap:break-word;
    overflow:auto;
    background:#f3f3f3;

}



#mirror{
    position:absolute;
    visibility:hidden;
    white-space:pre-wrap;
    word-break:break-word;
    overflow-wrap:break-word;
    padding:4px;
    font-family:monospace;
    box-sizing:border-box;
}
/* ===== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ ===== */
@media (prefers-color-scheme: dark){

    body{
        background:#1e1e1e;
        color:#e0e0e0;
    }

    #menu{
        background:#2a2a2a;
        border-bottom:1px solid #444;
    }

    #menu button{
        background:#3a3a3a;
        border:1px solid #555;
        color:#eee;
    }

    #outline{
        background:#252525;
        border-color:#444;
    }

    #leftPane{
        background:#10251d;
        color:#ddd;
    }

    #ruler{
        background:#444422;
        border-color:#555;
    }

    #editor{
        background:#1e1e1e;
        color:#ffffff;
    }

    .outline-item.active-heading::before{
        background:#00c896;
    }

    .current-line{
        border-bottom:2px solid #ff6b5e;
    }
    body.dark{
	    background:#1e1e1e;
	    color:#e0e0e0;
	}
	body.dark #editor{
	    background:#1e1e1e;
	    color:#fff;
	}
}


.current-line{
    position:absolute;
    left:0;
    right:0;
    pointer-events:none;
    border-bottom:2px solid #ff3d2e;	//#0b3d2e;
}
.heading-marker{
    position:absolute;
    left:0;
    right:0;
    height:6px;   /* â† ã“ã“ãŒå¤ªã• */
    background:orange;
    pointer-events:none;
    opacity:0.85;
}

/* ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ */
.outline-item{
    cursor:pointer;
    padding:2px 0;
}

.outline-item.active-heading{
    font-weight:bold;
    position:relative;
}

.outline-item.active-heading::before{
    content:"";
    position:absolute;
    left:-16px;
    top:2px;
    bottom:2px;
    width:4px;
    background:#0b3d2e;
}
</style>
</head>

<body>

<div id="menu">
<button id="menuToggle" onclick="toggleMenu()">â‰¡</button>
<button onclick="newFile()">æ–°è¦</button>
<button onclick="openFile()">é–‹ã</button>
<button onclick="saveFile()">ä¿å­˜</button>

<button onclick="setFontSize(16)">16</button>
<button onclick="setFontSize(20)">20</button>
<button onclick="setFontSize(30)">30</button>

<input type="text" id="searchText" placeholder="æ¤œç´¢">
<input type="text" id="replaceText" placeholder="ç½®æ›">
<label><input type="checkbox" id="caseCheck">Aa</label>
<button onclick="findPrev()">å‰</button>
<button onclick="findNext()">æ¬¡</button>
<button onclick="replaceOne()">ç½®æ›</button>
<button onclick="replaceAll()">å…¨</button>
<button onclick="toggleDark()">ğŸŒ™</button>

<input type="file" id="fileInput" style="display:none">
</div>

<div id="container">
<div id="outline"></div>

<div id="editorArea">
<div id="leftPane">
<div id="lineSpacer"></div>
<div id="lineNumbers"></div>
</div>

<div id="rightPane">
<div id="ruler"></div>
<div id="editorWrapper">
<textarea id="editor"></textarea>
<div id="mirror"></div>
<div id="markerLayer"></div>
<div id="currentLine" class="current-line"></div>
</div>
</div>
</div>
</div>

<script>
const editor=document.getElementById("editor");
const outline=document.getElementById("outline");
const leftPane=document.getElementById("leftPane");
const lineNumbers=document.getElementById("lineNumbers");
const lineSpacer=document.getElementById("lineSpacer");
const ruler=document.getElementById("ruler");
const fileInput=document.getElementById("fileInput");
const currentLine=document.getElementById("currentLine");
const mirror=document.getElementById("mirror");
const markerLayer = document.getElementById("markerLayer");

let collapsedHeadings=new Set();
let currentFileName=null;

/* ===== å›è»¢æ¤œå‡º ===== */
function checkOrientation(){
    if(window.innerWidth>window.innerHeight)
        document.body.classList.add("landscape");
    else
        document.body.classList.remove("landscape");
}
window.addEventListener("load",checkOrientation);
window.addEventListener("resize",checkOrientation);
window.addEventListener("orientationchange",()=>setTimeout(()=>{
    checkOrientation();
    updateAll();
},200));

/* ===== ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆèª¿æ•´ ===== */
function adjustLayout(){
    const h=document.getElementById("menu").offsetHeight;
    document.documentElement.style
        .setProperty("--menu-height", h+"px");
}

window.addEventListener("load",adjustLayout);
window.addEventListener("resize",adjustLayout);

/* ===== ãƒ•ã‚©ãƒ³ãƒˆ ===== */
function setFontSize(size){
    const px=size;
    const lh=Math.round(px*1.5);
    editor.style.fontSize=px+"px";
    mirror.style.fontSize=px+"px";
    leftPane.style.fontSize=px+"px";
    ruler.style.fontSize=px+"px";
    editor.style.lineHeight=lh+"px";
    mirror.style.lineHeight=lh+"px";
    leftPane.style.lineHeight=lh+"px";
    updateAll();
}
function toggleMenu(){
    document.body.classList.toggle("menu-collapsed");
    adjustLayout(); // é«˜ã•å†è¨ˆç®—
}


/* ===== ãƒ«ãƒ¼ãƒ©ãƒ¼ ===== */
function updateRuler(){
    let t="";
    for(let i=1;i<=200;i++) t+=(i%10==0)?(i/10):".";
    ruler.textContent=t;
}

/* ===== è¡Œç•ªå· ===== */
function updateLineNumbers(){
    mirror.style.width=editor.clientWidth+"px";
    const lh=parseFloat(editor.style.lineHeight);
    const lines=editor.value.split("\n");

    let out="";

    lines.forEach((line,i)=>{
        mirror.textContent=line||" ";
        const wrap=Math.max(1,Math.round(mirror.scrollHeight/lh));

        out+=(i+1)+"\n";
        for(let j=1;j<wrap;j++) out+=" \n";
    });

    lineNumbers.textContent=out;
}



/* ===== ç¾åœ¨è¡Œ ===== */
function updateCurrentLine(){
    const caret=editor.selectionStart;
    let text=editor.value.substring(0,caret);
    if(text.endsWith("\n")) text+=" ";
    mirror.style.width=editor.clientWidth+"px";
    mirror.textContent=text||" ";
    const h=mirror.scrollHeight;
    const lh=parseFloat(editor.style.lineHeight);
    currentLine.style.height=lh+"px";
    currentLine.style.top=(h-lh-editor.scrollTop -7)+"px";
}
function updateHeadingMarkers(){

    markerLayer.innerHTML = "";

    const lines = editor.value.split("\n");
    const lh = parseFloat(editor.style.lineHeight);
    const paddingTop = parseFloat(
        getComputedStyle(editor).paddingTop
    );

    mirror.style.width = editor.clientWidth + "px";

    let textBefore = "";

    for(let i=0;i<lines.length;i++){

        const line = lines[i];

        if(/^#+\s/.test(line)){

            let y;

            if(textBefore === ""){
                y = paddingTop + 4;   // â† ã“ã“ã§å¾®èª¿æ•´
            }else{
                mirror.textContent = textBefore;
                y = mirror.scrollHeight;
            }

            const marker = document.createElement("div");
            marker.className = "heading-marker";

            marker.style.top =
                (y - editor.scrollTop + (lh - 9)) + "px";	//â†(lh - 6)ã®å€¤ã§ä½ç½®ã‚’èª¿æ•´

            markerLayer.appendChild(marker);
        }

        textBefore += line + "\n";
    }
}



/* ===== ã‚¢ã‚¦ãƒˆãƒ©ã‚¤ãƒ³ ===== */
function updateOutline(){
    outline.innerHTML="";
    const lines=editor.value.split("\n");
    let hideLevel=null;

    for(let i=0;i<lines.length;i++){
        const m=lines[i].match(/^(#+)\s+(.*)$/);
        if(!m) continue;

        const level=m[1].length;

        if(hideLevel!==null){
            if(level>hideLevel) continue;
            else hideLevel=null;
        }

        // â˜… ã“ã‚ŒãŒæŠœã‘ã¦ã„ãŸ
        const div=document.createElement("div");
        div.className="outline-item";
        div.dataset.line=i;
        div.dataset.level=level;

        const icon=document.createElement("span");

        // ãƒ¬ãƒ™ãƒ«åˆ¥ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆ
        const indent="ã€€".repeat(level-1);
        icon.textContent=
            indent + (collapsedHeadings.has(i) ? "â–¶ " : "â–¼ ");

        icon.onclick=(e)=>{
            e.stopPropagation();
            toggleCollapse(i);
        };

        const text=document.createElement("span");
        text.textContent=m[2];

        div.appendChild(icon);
        div.appendChild(text);
        div.onclick=()=>jumpToLine(i);

        outline.appendChild(div);

        if(collapsedHeadings.has(i)) hideLevel=level;
    }

    highlightCurrentHeading();
}


function toggleCollapse(line){
    if(collapsedHeadings.has(line))
        collapsedHeadings.delete(line);
    else
        collapsedHeadings.add(line);
    updateOutline();
}

function highlightCurrentHeading(){
    const cursorLine=
        editor.value.substring(0,editor.selectionStart)
        .split("\n").length-1;

    const items=document.querySelectorAll(".outline-item");
    items.forEach(i=>i.classList.remove("active-heading"));

    let best=null;
    let bestLine=-1;

    items.forEach(item=>{
        const line=parseInt(item.dataset.line);
        if(line<=cursorLine && line>bestLine){
            bestLine=line;
            best=item;
        }
    });

    if(best) best.classList.add("active-heading");
}

document.addEventListener("selectionchange",()=>{
    if(document.activeElement===editor){
        updateCurrentLine();
        highlightCurrentHeading();
    }
});

function jumpToLine(line){
    const lines=editor.value.split("\n");
    let pos=0;
    for(let i=0;i<line;i++) pos+=lines[i].length+1;
    editor.focus();
    editor.setSelectionRange(pos,pos);
}

/* ===== æ¤œç´¢ç½®æ› ===== */
function findNext(){

    const keyword = document.getElementById("searchText").value;
    if(!keyword) return;

    const flags = document.getElementById("caseCheck").checked ? "g" : "gi";
    const regex = new RegExp(keyword, flags);

    const text = editor.value;
    const start = editor.selectionEnd;

    let match;
    let index = -1;

    while((match = regex.exec(text)) !== null){
        if(match.index >= start){
            index = match.index;
            break;
        }
    }

    // æœ«å°¾ã¾ã§ç„¡ã‘ã‚Œã°å…ˆé ­ã¸
    if(index === -1){
        regex.lastIndex = 0;
        match = regex.exec(text);
        if(!match){
            alert("è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            return;
        }
        index = match.index;
    }

    editor.focus();
    editor.setSelectionRange(index, index + match[0].length);

    scrollToSelection();
}
function findPrev(){

    const keyword = document.getElementById("searchText").value;
    if(!keyword) return;

    const flags = document.getElementById("caseCheck").checked ? "g" : "gi";
    const regex = new RegExp(keyword, flags);

    const text = editor.value;
    const start = editor.selectionStart;

    let match;
    let lastValid = null;

    while((match = regex.exec(text)) !== null){
        if(match.index < start){
            lastValid = match;
        }else{
            break;
        }
    }

    // å…ˆé ­ã¾ã§ç„¡ã‘ã‚Œã°æœ«å°¾ã¸
    if(!lastValid){
        while((match = regex.exec(text)) !== null){
            lastValid = match;
        }
        if(!lastValid){
            alert("è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
            return;
        }
    }

    editor.focus();
    editor.setSelectionRange(
        lastValid.index,
        lastValid.index + lastValid[0].length
    );

    scrollToSelection();
}

function scrollToSelection(){

    const caret = editor.selectionStart;

    let text = editor.value.substring(0, caret);
    if(text.endsWith("\n")) text += " ";

    mirror.style.width = editor.clientWidth + "px";
    mirror.textContent = text || " ";

    const caretHeight = mirror.scrollHeight;
    const lineHeight = parseFloat(editor.style.lineHeight);

    // ä¸­å¤®ä»˜è¿‘ã«è¡¨ç¤º
    editor.scrollTop = caretHeight - (editor.clientHeight / 2);

    updateLineNumbers();
}


function replaceOne(){
    const keyword=document.getElementById("searchText").value;
    const replacement=document.getElementById("replaceText").value;
    const flags=document.getElementById("caseCheck").checked?"":"i";
    const regex=new RegExp("^"+keyword+"$",flags);
    const selected=editor.value.substring(editor.selectionStart,editor.selectionEnd);
    if(regex.test(selected)){
        const before=editor.value.substring(0,editor.selectionStart);
        const after=editor.value.substring(editor.selectionEnd);
        editor.value=before+replacement+after;
        updateAll();
    }
    findNext();
}

function replaceAll(){
    const keyword=document.getElementById("searchText").value;
    const replacement=document.getElementById("replaceText").value;
    const flags=document.getElementById("caseCheck").checked?"g":"gi";
    const regex=new RegExp(keyword,flags);
    editor.value=editor.value.replace(regex,replacement);
    updateAll();
}

/* ===== ãƒ•ã‚¡ã‚¤ãƒ« ===== */
function newFile(){
    if(editor.value&&!confirm("ç ´æ£„ã—ã¾ã™ã‹ï¼Ÿ")) return;
    editor.value="";
    currentFileName=null;
    updateAll();
}
function openFile(){ fileInput.click(); }
fileInput.addEventListener("change",e=>{
    const file=e.target.files[0];
    if(!file) return;
    const reader=new FileReader();
    reader.onload=evt=>{
        editor.value=evt.target.result;
        currentFileName=file.name;
        updateAll();
    };
    reader.readAsText(file,"UTF-8");
});
function saveFile(){
    const blob=new Blob([editor.value],{type:"text/plain"});
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=currentFileName||"untitled.txt";
    a.click();
}
function toggleDark(){
    document.body.classList.toggle("dark");
}


/* ===== ã‚¤ãƒ™ãƒ³ãƒˆ ===== */
editor.addEventListener("input",updateAll);
editor.addEventListener("scroll",()=>{
    leftPane.scrollTop=editor.scrollTop;
    updateCurrentLine();
    updateHeadingMarkers();   // â† å¿…ãšå…¥ã‚Œã‚‹
});
document.addEventListener("keydown",e=>{
    if(e.ctrlKey&&e.key==="s"){
        e.preventDefault();
        saveFile();
    }
});

function updateAll(){
    updateRuler();
    lineSpacer.style.height=ruler.offsetHeight+"px";
    updateLineNumbers();
    updateOutline();
    updateCurrentLine();
    updateHeadingMarkers();   // â† è¿½åŠ 
}


setFontSize(20);

if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js');
}
</script>
</body>
</html>
